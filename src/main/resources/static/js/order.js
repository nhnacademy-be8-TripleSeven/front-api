document.addEventListener("DOMContentLoaded", () => {
    let originalAmount = 0;
    let deliveryFee = 0;
    let currentWrapperPrice = 0;
    let pointsUsed = 0;
    let availablePoints = 0;
    let isUsingPoints = false;
    let defaultDeliveryPrice = 0;
    let selectedPayType = null; // ÏÑ†ÌÉùÎêú Í≤∞Ï†ú Î∞©Ïãù Ï†ÄÏû•
    let deliveryMinPrice = 0;
    let couponUsed = 0;

    const userId = document.body.getAttribute("data-user-id");
    const finalAmountElems = document.querySelectorAll("#final-amount, #payment-info-final-amount");
    const deliveryFeeElem = document.getElementById("delivery-fee");
    const wrapperPriceDetailElem = document.getElementById("wrapper-price-detail");
    const pointUsedElem = document.getElementById("point-used");
    const couponUsedElem = document.getElementById("coupon-used");
    const pointsFinalAmountElem = document.getElementById("points-final-amount");
    const availablePointsElem = document.getElementById("available-points");
    const wrapperIdInput = document.getElementById("wrapper-id");
    const defaultDeliveryPriceElem = document.getElementById("defaultDeliveryPrice");
    const giftWrapInclude = document.getElementById("gift-wrap-include");
    const giftWrapExclude = document.getElementById("gift-wrap-exclude");
    const selectGiftWrapLink = document.getElementById("select-gift-wrap");
    const giftWrapModal = document.getElementById("gift-wrap-modal");
    const closeModalButton = document.getElementById("close-modal");
    const ordererNameInput = document.getElementById("customer-name");
    const deliveryMinPriceElem = document.getElementById("deliveryMinPrice");
    const progressBarFill = document.querySelector(".progress-bar");


    // ‚úÖ Î∞∞ÏÜ° ÎÇ†Ïßú Í¥ÄÎ†® ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
    const deliveryDateColumnIndex = userId != null ? 5 : 4; // userId Ïó¨Î∂ÄÏóê Îî∞Îùº Ïª¨Îüº Ïù∏Îç±Ïä§ Í≤∞Ï†ï
    const deliveryDateCells = document.querySelectorAll(`.product-table tbody tr td:nth-child(${deliveryDateColumnIndex})`);

    const deliveryDateOptions = document.querySelectorAll(".delivery-date-container .date");
    // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï

    originalAmount = parseInt(finalAmountElems[0].textContent.replace(/[^0-9]/g, "")) || 0;

    if (userId != null) {
        availablePoints = parseInt(availablePointsElem.textContent.replace(/[^0-9]/g, "")) || 0;
        couponUsed = parseInt(couponUsedElem.textContent.replace(/[^0-9]/g, "")) || 0;
    }

    defaultDeliveryPrice = parseInt(defaultDeliveryPriceElem.textContent.replace(/[^0-9]/g, "")) || 0;
    deliveryMinPrice = parseInt(deliveryMinPriceElem.textContent.replace(/[^0-9]/g, "")) || 0;

    updateFinalAmount();

    // Ìè¨Ïù∏Ìä∏ ÏÇ¨Ïö© Ïó¨Î∂Ä Ï≤òÎ¶¨
    if (userId != null) {
        document.getElementById("use-points-yes").addEventListener("change", () => {
            isUsingPoints = true;
            pointsUsed = Math.min(originalAmount + currentWrapperPrice + deliveryFee, availablePoints);
            updateFinalAmount();
        });

        document.getElementById("use-points-no").addEventListener("change", () => {
            isUsingPoints = false;
            pointsUsed = 0;
            updateFinalAmount();
        });
    }




    // Ìè¨Ïû•ÏßÄ ÏÑ†ÌÉù Ï≤òÎ¶¨
    giftWrapInclude.addEventListener("change", () => {
        if (giftWrapInclude.checked) {
            selectGiftWrapLink.style.pointerEvents = "auto";
            selectGiftWrapLink.style.color = "#007bff";
        }
    });

    giftWrapExclude.addEventListener("change", () => {
        currentWrapperPrice = 0;
        wrapperIdInput.value = null;
        console.log("Ìè¨Ïû•ÏßÄ ÏÑ†ÌÉù Ìï¥Ï†úÎê®");
        updateFinalAmount();
    });

    selectGiftWrapLink.addEventListener("click", (event) => {
        event.preventDefault();
        if (giftWrapInclude.checked) {
            giftWrapModal.classList.remove("hidden");
        }
    });

    closeModalButton.addEventListener("click", () => {
        giftWrapModal.classList.add("hidden");
    });

    document.querySelectorAll(".wrapper-item").forEach(item => {
        item.addEventListener("click", () => {
            const wrapperId = item.getAttribute("data-id");
            currentWrapperPrice = parseInt(item.getAttribute("data-price")) || 0;
            wrapperIdInput.value = wrapperId;
            console.log(`Ìè¨Ïû•ÏßÄ ÏÑ†ÌÉùÎê®: ID = ${wrapperId}, Í∞ÄÍ≤© = ${currentWrapperPrice}Ïõê`);
            updateFinalAmount();
            giftWrapModal.classList.add("hidden");
        });
    });

    // ‚úÖ Î∞∞ÏÜ° ÎÇ†Ïßú ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ (ÌöåÏõê/ÎπÑÌöåÏõê Î™®Îëê Í∞ÄÎä•)
    deliveryDateOptions.forEach(dateElement => {
        dateElement.addEventListener("click", () => {
            // Í∏∞Ï°¥ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Ï†úÍ±∞
            deliveryDateOptions.forEach(elem => elem.classList.remove("active"));

            // ÏÉàÎ°ú ÏÑ†ÌÉùÌïú ÎÇ†Ïßú ÌôúÏÑ±Ìôî
            dateElement.classList.add("active");

            // ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÎ•º Î™®Îì† ÏÉÅÌíàÏùò Î∞∞ÏÜ°Ïùº ÏÖÄÏóê Ï†ÅÏö©
            const selectedDate = dateElement.getAttribute("data-date");
            deliveryDateCells.forEach(cell => {
                cell.textContent = `${selectedDate}`;
            });

            console.log(`üìå ÏÑ†ÌÉùÎêú Î∞∞ÏÜ° ÎÇ†Ïßú: ${selectedDate}`);
        });
    });

    // ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
    function updateFinalAmount() {

        let tempAmount;
        if (userId != null) {
            // const couponUsedElem = document.getElementById("coupon-used");
            couponUsed = parseInt(couponUsedElem.textContent.replace(/[^0-9]/g, "")) || 0;
            tempAmount = originalAmount + currentWrapperPrice - pointsUsed - couponUsed;
        } else {
            tempAmount = originalAmount + currentWrapperPrice;

        }
        console.log("originalAmount", originalAmount);
        console.log("currentWrapperPrice", currentWrapperPrice);
        console.log("pointUsed", pointsUsed);
        console.log("couponUsed", couponUsed);
        console.log("tempAmount", tempAmount);
        if (tempAmount < deliveryMinPrice) {
            deliveryFee = defaultDeliveryPrice;
        } else {
            deliveryFee = 0;
        }
        console.log("deliveryFee", deliveryFee);

        const totalAmount = tempAmount + deliveryFee;
        const remainingPoints = availablePoints - pointsUsed;

        wrapperPriceDetailElem.textContent = `${currentWrapperPrice.toLocaleString()} Ïõê`;
        if (userId != null) {
            pointUsedElem.textContent = `${pointsUsed.toLocaleString()} Ïõê`;
            pointsFinalAmountElem.textContent = `${(totalAmount - remainingPoints).toLocaleString()} Ïõê`;

            availablePointsElem.textContent = `${remainingPoints.toLocaleString()} PT`;
        }
        deliveryFeeElem.textContent = `${deliveryFee.toLocaleString()} Ïõê`;

        finalAmountElems.forEach(elem => {
            elem.textContent = `${totalAmount.toLocaleString()} Ïõê`;
        });

        let progressWidth = Math.min((tempAmount / deliveryMinPrice) * 100, 100);
        progressBarFill.style.width = `${progressWidth}%`;
        if (progressWidth >= 100) {
            progressBarFill.style.backgroundColor = "#4CAF50"; // Î¨¥Î£å Î∞∞ÏÜ° ÎèÑÎã¨ Ïãú Ï¥àÎ°ùÏÉâ
        } else {
            progressBarFill.style.backgroundColor = "#6e8cba"; // Í∏∞Î≥∏ ÏÉâÏÉÅ
        }

    }


// Ìèº Ï†úÏ∂ú Ìï®Ïàò ÏàòÏ†ï
    function submitOrderForm() {
        const form = document.createElement("form");
        form.method = "post";
        form.action = "/frontend/payment";
        form.enctype = "application/x-www-form-urlencoded";

        const addHiddenField = (name, value) => {
            if (value !== null && value !== "") {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }
        };

        document.querySelectorAll(".product-table tbody tr").forEach((row, index) => {
            const bookId = parseInt(row.querySelector("a").getAttribute("href").split("/").pop());
            const title = row.querySelector("a").textContent;

            if (userId != null) {
                const price = document.getElementById("discountedPrice").textContent.replace(/[^0-9]/g, "") || 0;
                console.log("price = ",price);
                addHiddenField(`bookOrderDetails[${index}].price`, price);
                const quantity = parseInt(row.querySelector("td:nth-child(3)").textContent.trim());
                addHiddenField(`bookOrderDetails[${index}].quantity`, quantity);
                const couponSalePrice = parseInt(couponUsedElem.textContent.replace(/[^0-9]/g, "")) || 0;
                addHiddenField(`bookOrderDetails[${index}].couponSalePrice`, couponSalePrice)
                const couponId = appliedCoupons[bookId] ? appliedCoupons[bookId] : null;
                addHiddenField(`bookOrderDetails[${index}].couponId`, couponId);
            } else {
                const price = parseInt(row.querySelector("td:nth-child(5)").textContent.replace(/[^0-9]/g, ""));
                addHiddenField(`bookOrderDetails[${index}].price`, price);
                const quantity = parseInt(row.querySelector("td:nth-child(2)").textContent.trim());
                addHiddenField(`bookOrderDetails[${index}].quantity`, quantity);

            }
            addHiddenField(`bookOrderDetails[${index}].bookId`, bookId);
            addHiddenField(`bookOrderDetails[${index}].title`, title);


        });

        addHiddenField("recipientInfo.recipientName", document.getElementById("name").value);
        addHiddenField("recipientInfo.recipientPhone", `${document.getElementById("mobile-phone1").value}${document.getElementById("mobile-phone2").value}${document.getElementById("mobile-phone3").value}`);
        addHiddenField("recipientInfo.recipientLandline", `${document.getElementById("landline-phone1").value}${document.getElementById("landline-phone2").value}${document.getElementById("landline-phone3").value}`);
        addHiddenField("addressInfo.roadAddress", document.getElementById("roadAddress").value);
        addHiddenField("addressInfo.zoneAddress", document.getElementById("jibunAddress").value);
        addHiddenField("addressInfo.detailAddress", document.getElementById("detailAddress").value);
        addHiddenField("wrapperId", wrapperIdInput.value);
        addHiddenField("point", pointsUsed);
        addHiddenField("totalAmount", parseInt(document.querySelector("#final-amount").textContent.replace(/[^0-9]/g, "")));
        addHiddenField("deliveryFee", deliveryFee);
        const selectedDateElement = document.querySelector(".delivery-date-container .date.active");
        if (selectedDateElement) {
            const deliveryDate = convertToDate(selectedDateElement.getAttribute("data-date"));
            addHiddenField("deliveryDate", deliveryDate);
        } else {
            alert("Î∞∞ÏÜ° ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }

        addHiddenField("ordererName", ordererNameInput.value);

        // ÏÑ†ÌÉùÎêú Í≤∞Ï†ú Î∞©ÏãùÏùÑ Ï∂îÍ∞Ä
        if (!selectedPayType) {
            alert("Í≤∞Ï†ú Î∞©ÏãùÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }
        addHiddenField("payType", selectedPayType); // payType Ï∂îÍ∞Ä

        document.body.appendChild(form);
        form.submit();
    }

    // ÎÇ†Ïßú ÌòïÏãù Î≥ÄÌôò Ìï®Ïàò ("01/19(Ïùº)" -> "2025-01-19")
    function convertToDate(rawDate) {
        const [month, dayWithRest] = rawDate.split("/");
        const day = dayWithRest.split("(")[0];
        const year = new Date().getFullYear();
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }

    // Í≤∞Ï†ú Î∞©Ïãù ÏÑ†ÌÉù Ïãú Ìò∏Ï∂úÎêòÎäî Ìï®Ïàò
    function selectPayment(method) {
        alert(`${method} Í≤∞Ï†úÍ∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`);
        selectedPayType = method;
    }

    function showUnsupportedMessage() {
        alert("ÌòÑÏû¨Îäî ÌÜ†Ïä§ Í≤∞Ï†úÎßå ÏßÄÏõêÎê©ÎãàÎã§.");
    }

    window.submitOrderForm = submitOrderForm;
    window.selectPayment = selectPayment; // Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú
    window.updateFinalAmount = updateFinalAmount;
    window.showUnsupportedMessage = showUnsupportedMessage; // Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú
});